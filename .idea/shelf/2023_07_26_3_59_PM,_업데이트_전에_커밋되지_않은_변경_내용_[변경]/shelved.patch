Index: app/response_generator.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import json\n\nfrom chatlib.chatbot.generators import ChatGPTResponseGenerator, StateBasedResponseGenerator, StateType\n\nfrom app.common import EmotionChatbotPhase\nfrom app.phases import rapport, label, find, record, share\nfrom chatlib.chatbot import ResponseGenerator, Dialogue\nfrom chatlib.mapper import ChatGPTDialogueSummarizer\nfrom chatlib.openai_utils import ChatGPTParams\n\n\nclass EmotionChatbotResponseGenerator(StateBasedResponseGenerator[EmotionChatbotPhase]):\n\n    def __init__(self, user_name: str | None = None, user_age: int = None, verbose: bool = False):\n        super().__init__(initial_state=EmotionChatbotPhase.Rapport, verbose=verbose)\n\n        self.__user_name = user_name\n        self.__user_age = user_age\n\n        self.__generators: dict[EmotionChatbotPhase, ResponseGenerator] = dict()\n\n        self.__generators[EmotionChatbotPhase.Rapport] = rapport.create_generator()\n        self.__generators[EmotionChatbotPhase.Label] = label.create_generator()\n        self.__generators[EmotionChatbotPhase.Find] = find.create_generator()\n        self.__generators[EmotionChatbotPhase.Record] = record.create_generator()\n        self.__generators[EmotionChatbotPhase.Share] = share.create_generator()\n\n    def write_to_json(self, parcel: dict):\n        super().write_to_json(parcel)\n        parcel[\"user_name\"] = self.__user_name\n        parcel[\"user_age\"] = self.__user_age\n\n    def restore_from_json(self, parcel: dict):\n        self.__user_name = parcel[\"user_name\"]\n        self.__user_age = parcel[\"user_age\"]\n\n        super().restore_from_json(parcel)\n\n    async def get_generator(self, state: StateType, payload: dict | None) -> ResponseGenerator:\n        # Get generator caches\n        generator = self.__generators[state]\n\n        if state == EmotionChatbotPhase.Rapport:\n            if isinstance(generator, ChatGPTResponseGenerator):\n                generator.update_instruction_parameters(dict(user_name = self.__user_name, user_age = self.__user_age))\n        elif state == EmotionChatbotPhase.Label:\n            if isinstance(generator, ChatGPTResponseGenerator):\n                generator.update_instruction_parameters(payload)  # Put the result of rapport conversation\n        elif state == EmotionChatbotPhase.Find:\n            await generator.initialize()\n        elif state == EmotionChatbotPhase.Record:\n            await generator.initialize()\n        elif state == EmotionChatbotPhase.Share:\n            await generator.initialize()\n\n        return generator\n\n    async def calc_next_state_info(self, current: EmotionChatbotPhase, dialog: Dialogue) -> tuple[\n                                                                                                EmotionChatbotPhase, dict | None] | None:\n        # Rapport --> Label\n        if current == EmotionChatbotPhase.Rapport:\n            # Minimum 3 rapport building conversation turns\n            if len(dialog) > 3:\n                phase_suggestion = json.loads(await rapport.summarizer.run(dialog))\n                print(phase_suggestion)\n                # print(f\"Phase suggestion: {phase_suggestion}\")\n                if \"move_to_next\" in phase_suggestion and phase_suggestion[\"move_to_next\"] is True:\n                    return EmotionChatbotPhase.Label, phase_suggestion\n                else:\n                    return None\n        # Label --> Find OR Record\n        elif current == EmotionChatbotPhase.Label:\n            phase_suggestion = json.loads(await label.summarizer.run(dialog))\n            print(phase_suggestion)\n            if \"next_phase\" in phase_suggestion and isinstance(phase_suggestion[\"next_phase\"], str):\n                if phase_suggestion[\"next_phase\"].lower() == \"find\":\n                    return EmotionChatbotPhase.Find, phase_suggestion\n                elif phase_suggestion[\"next_phase\"].lower() == \"record\":\n                    return EmotionChatbotPhase.Record, phase_suggestion\n            else:\n                return None\n\n        # Find OR Record --> Share\n        elif current == EmotionChatbotPhase.Find or current == EmotionChatbotPhase.Record:\n            phase_classifier = ChatGPTDialogueSummarizer(\n                base_instruction=f\"\"\"\n                    Analyze the content of the conversation.\n                    Determine whether it is reasonable to move on to the next conversation phase or not.\n\n                    Rules:\n                    1) Answer options: \"Share\", \"Find\", or \"Record\". \n                    2) If {current} is \"Find\", return \"Share,\" only when the user found a solution. \n                    3) If {current} is \"Record\", return \"Share,\" only when you made 3 conversation turns. \n                    \"\"\",\n                gpt_params=ChatGPTParams(temperature=0.1)\n            )\n            phase_suggestion = (await phase_classifier.run(dialog)).lower()\n            if \"share\" in phase_suggestion:\n                return EmotionChatbotPhase.Share, None\n            else:\n                return None\n        else:\n            return None\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/response_generator.py b/app/response_generator.py
--- a/app/response_generator.py	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ b/app/response_generator.py	(date 1690344412112)
@@ -89,7 +89,7 @@
 
                     Rules:
                     1) Answer options: "Share", "Find", or "Record". 
-                    2) If {current} is "Find", return "Share," only when the user found a solution. 
+                    2) If {current} is "Find", return "Share," only when the user found a solution and determined to follow a solution. 
                     3) If {current} is "Record", return "Share," only when you made 3 conversation turns. 
                     """,
                 gpt_params=ChatGPTParams(temperature=0.1)
@@ -99,5 +99,25 @@
                 return EmotionChatbotPhase.Share, None
             else:
                 return None
+
+        # Share --> Label
+        elif current == EmotionChatbotPhase.Share :
+            phase_classifier = ChatGPTDialogueSummarizer(
+                base_instruction=f"""
+                    Analyze the content of the conversation.
+                    Determine whether it is reasonable to move on to the next conversation phase or not.
+
+                    Rules:
+                    1) Answer options: "Share", or "Label". 
+                    2) If the user would like to share more episodes that are memorable, ask about the episode and return "Label".
+                    3) If the user does not want to share more episodes, end the conversation.
+                    """,
+                gpt_params=ChatGPTParams(temperature=0.1)
+            )
+            phase_suggestion = (await phase_classifier.run(dialog)).lower()
+            if "label" in phase_suggestion:
+                return EmotionChatbotPhase.Label, None
+            else:
+                return None
         else:
             return None
Index: ì‚°ë§Œí•˜ê³  ì¶©ë™ì ì´ë¼ ì¹œêµ¬ì™€ ì¶©ëŒì´ ë§ì€ ì–´ë¦°ì´ (ë¯¼ìˆ˜, 11).txt
===================================================================
diff --git a/ì‚°ë§Œí•˜ê³  ì¶©ë™ì ì´ë¼ ì¹œêµ¬ì™€ ì¶©ëŒì´ ë§ì€ ì–´ë¦°ì´ (ë¯¼ìˆ˜, 11).txt b/ì‚°ë§Œí•˜ê³  ì¶©ë™ì ì´ë¼ ì¹œêµ¬ì™€ ì¶©ëŒì´ ë§ì€ ì–´ë¦°ì´ (ë¯¼ìˆ˜, 11).txt
deleted file mode 100644
--- a/ì‚°ë§Œí•˜ê³  ì¶©ë™ì ì´ë¼ ì¹œêµ¬ì™€ ì¶©ëŒì´ ë§ì€ ì–´ë¦°ì´ (ë¯¼ìˆ˜, 11).txt	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ /dev/null	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
@@ -1,30 +0,0 @@
-<Chatbot> ì•ˆë…•, ë¯¼ìˆ˜ì•¼! ë‚œ ì±—ë´‡ì´ë¼ê³  í•´. ë‚˜ë„ ë„ˆë‘ ë˜‘ê°™ì´ 11ì‚´ì´ì•¼. ë‚œ ì–˜ê¸°í•˜ëŠ” ê±¸ ì •ë§ ì¢‹ì•„í•˜ê³ , íŠ¹íˆ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ í•  ë•ŒëŠ” ë” ì¦ê±°ì›Œ. ë„ˆëŠ” ë¬´ìŠ¨ ì·¨ë¯¸ê°€ ìˆì–´? ì–´ë–¤ ê²ƒë“¤ì„ ì¢‹ì•„í•˜ë‹ˆ? ({'state': <EmotionChatbotPhase.Rapport: 'rapport'>, 'payload': None}) - 9045 sec
-<Child>   ì•ˆë…•í•˜ì œ? ë‚œ ì£¼ë¡œ ê²Œì„í•˜êµ¬ ë†€ì§€. FPSê²Œì„ì´ë‚˜ ì‹ ë‚˜ëŠ” ê²Œì„ ì¢‹ì•„í–‰. ì†”ì§íˆ ë‚¨ë“¤ì˜ ìƒê°ì€ ë³„ë¡œ ì‹ ê²½ ì•ˆ ì¨. (None) - 3007 sec
-<Chatbot> í—, ë‚œë„ ê²Œì„ ì •ë§ ì¢‹ì•„í•´! íŠ¹íˆ ì‹ ë‚˜ëŠ” ê²Œì„ì´ë¼ë©´ ë”ë”ìš±! ë„ˆê°€ ì¢‹ì•„í•˜ëŠ” ê²Œì„ ì¤‘ì— ë‚´ê°€ í•  ìˆ˜ ìˆì„ ë§Œí•œ ê²ƒì´ ìˆë‹¤ë©´ ì¶”ì²œ ì¢€ í•´ì¤„ë˜? ê·¸ë¦¬ê³ , ë‚œ ë„ˆì²˜ëŸ¼ ìƒê°í•´. ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” ê±¸ í•˜ëŠ” ê²Œ ì œì¼ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•´! ê±°, ê·¸ê²Œ ì•„ë‹ˆë¼ ì˜¤ëŠ˜ì€ ì–´ë–»ê²Œ ë³´ëƒˆì–´? ë†€ê±°ë‚˜ ê²Œì„í•˜ë©° ì¬ë°ŒëŠ” ì¼ ìˆì—ˆì–´? ({'state': <EmotionChatbotPhase.Rapport: 'rapport'>, 'payload': None}) - 9226 sec
-<Child>   ê³„ì† ê²Œì„í•˜ê³  ì‹¶ë‹¤ë‹ˆê¹Œ. FPS ê²Œì„ì´ë©´ ë„ˆë„ í•  ìˆ˜ ìˆê² ë‹¤. í•œ ë²ˆ í•´ë´¤ìœ¼ë©´ ì¢‹ê² ë‹¤ëŠ” ìƒê°ì€ ì•ˆë“¤ì—ˆëŠ”ë°. ê·¸ëƒ¥ ì˜¤ëŠ˜ë„ ê·¸ë˜ ê·¸ëŸ° í•˜ë£¨ì˜€ì–´. (None) - 4372 sec
-<Chatbot> ê·¸ë ‡êµ¬ë‚˜, FPSê²Œì„ì´ ê½¤ ì¬ë°Œê² ë‹¤! ì•„ë§ˆ ë‚˜ë„ ì¢‹ì•„í•  ê²ƒ ê°™ì•„! ì˜¤ëŠ˜ ê·¸ì € ê·¸ëŸ° í•˜ë£¨ì˜€ë‹¤ë‹ˆ, ê·¸ëŸ´ ë•Œë„ ìˆì§€! ê·¸ëŸ¼, ë¯¼ìˆ˜ê°€ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ì¼ì€ ë¬´ì—‡ì¸ì§€ ì•Œë ¤ì¤„ ìˆ˜ ìˆì„ê¹Œ? ì¢‹ì•˜ë˜ ì¼ì´ë‚˜ ë‚˜ë¹´ë˜ ì¼, í˜¹ì€ ê°€ì¥ ì¬ë¯¸ìˆì—ˆë˜ ì¼ ë§í•´ë´! ({'state': <EmotionChatbotPhase.Rapport: 'rapport'>, 'payload': None}) - 8557 sec
-<Child>   ì‘, ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ê±´... ì–´ì œ í•™êµì—ì„œ ì¼ì–´ë‚œ ì¼ì´ì•¼. ì ì‹¬ì‹œê°„ì— ì¢€ ì  ì¢€ ìë ¤ê³  í–ˆëŠ”ë° ë‹¤ë“¤ ë„ˆë¬´ ì‹œë„ëŸ¬ì›Œì„œ ê¹¨ì§. ì†”ì§íˆ ë§ì´ ì§œì¦ë‚¬ì–´. (None) - 4812 sec
-<Chatbot> ê·¸ë¬êµ¬ë‚˜, ì ì‹¬ì‹œê°„ì— ì  ì¢€ ìë ¤ëŠ”ë° ì‹œë„ëŸ¬ì›Œì„œ ê¹¨ì¡Œë‹¤ë‹ˆ... ë„ˆë¬´ ì‹«ì„ ê±° ê°™ì•„. ì§œì¦ ë‚œ ê¸°ë¶„ì´ ë“¤ì—ˆì„ ìˆ˜ë„ ìˆì„ ê±° ê°™ê³ , ë” ìì„¸íˆ ì•Œë ¤ì£¼ë©´ ì¢‹ì„ ê±° ê°™ì•„. ì˜ˆë¥¼ ë“¤ë©´, ìŠ¬í”„ê±°ë‚˜ ë¶ˆì¾Œí•˜ê²Œ ëŠê¼ˆëŠ”ì§€, ì•„ë‹ˆë©´ í™”ê°€ ë‚¬ëŠ”ì§€ í˜¹ì€ ë‹¤ ë‘ë ¤ì› ëŠ”ì§€ ë§ì´ì•¼. ({'state': <EmotionChatbotPhase.Label: 'label'>, 'payload': None}) - 12183 sec
-<Child>   ìŒ ì–´ì œ ê·¸ ì¼ì´ ìˆì—ˆì„ ë•Œ í™”ê°€ ë§ì´ ë‚¬ì–´. ë‚®ì  ì˜ ë•Œ ì‹œë„ëŸ¬ì›Œì„œ ì ì—ì„œ ê¹¨ëŠ” ê±´ ì§„ì§œ ì§œì¦ë‚˜. ê·¸ë˜ì„œ ê·¸ í›„ì— ì¹œêµ¬ë“¤í•˜ê³  ì‹¸ì› ì–´. (None) - 5196 sec
-<Chatbot> ê·¸ë¬êµ¬ë‚˜, ì ì—ì„œ ê¹¨ì„œ í™”ê°€ ë§ì´ ë‚¬êµ¬ë‚˜. ê·¸ë¥´ì¹˜ í™”ë‚¬ì„ ë•ŒëŠ” ë„ì™€ì¤„ ëª»í•´ì„œ ë¯¸ì•ˆí•´. ê·¸ëŸ°ë° ê·¸ë•Œ ì¹œêµ¬ë“¤í•˜ê³  ì‹¸ìš°ì§€ ì•Šì•„ë„ ê´œì°®ì„ ê±° ê°™ì•„. í™”ë¥¼ ì°¸ëŠ” ê±´ ì–´ë µì§€ë§Œ, ê·¸ë ‡ê²Œ í•˜ë‹¤ ë³´ë©´ í™”ë¥¼ ì¡°ì ˆí•˜ëŠ” ë²•ì„ ë°°ìš¸ ìˆ˜ ìˆì–´! ê·¸ëŸ¼, ê·¸ ì¼ì´ ìˆì€ í›„ë¡œ ë¶„ìœ„ê¸°ëŠ” ì–´ë• ì–´? ì¹œêµ¬ë“¤ê³¼ ë‹¤ì‹œ ì–´ë–»ê²Œ ì§€ëƒˆì–´? ({'state': <EmotionChatbotPhase.Label: 'label'>, 'payload': None}) - 17641 sec
-<Child>   ê·¸ ì¼ì´ ìˆê³  ë‚˜ì„œ ë¶„ìœ„ê¸°ëŠ” ì¢€ ì–´ìƒ‰í–ˆì–´. ì¹œêµ¬ë“¤ì´ ë‹¤ë“¤ ë§ë„ ì•ˆ ê±°ëŠ” ê±° ë³´ë‹ˆ ë‚˜ ë•Œë¬¸ì¸ ê±° ê°™ë”ë¼ê³ . ë‚´ê°€ ì›ë˜ í™”ë‚¬ì„ ë•ŒëŠ” ì†”ì§í•˜ê²Œ ë§í•˜ë‹ˆê¹Œ ë‹¤ë“¤ ì•Œê² ì§€. (None) - 5496 sec
-<Chatbot> ê·¸ë ‡êµ¬ë‚˜, ê·¸ëŸ¬ë‹ˆê¹Œ ì¹œêµ¬ë“¤ì´ë‘ ë¶„ìœ„ê¸°ê°€ ì¢€ ì–´ìƒ‰í•´ì§„ ê²ƒ ê°™ì•„? ì†”ì§í•˜ê²Œ í™”ë‚œ ê²ƒì„ í‘œí˜„í•˜ëŠ” ê±´ ì¢‹ì€ ê±° ê°™ì•„, í•˜ì§€ë§Œ ê·¸ê²Œ ì¹œêµ¬ë“¤ê³¼ì˜ ê´€ê³„ë¥¼ í•´ì¹  ìˆ˜ë„ ìˆì–´. í˜¹ì‹œ ì¹œêµ¬ë“¤ê³¼ ë‹¤ì‹œ ì¢‹ì€ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“¤ê³  ì‹¶ì§€ ì•Šì„ê¹Œ? ì•„, ì•„ë‹˜ ì¡°ê¸ˆ ë” ì‹œê°„ì„ ë‘ê³  ì‹¶ì–´? ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 11500 sec
-<Child>   ê·¸ëŸ° ê±´ ë‚˜ë„ ì˜ ëª¨ë¥´ê² ì–´. ê·¸ëƒ¥ ìˆì„ ë•ŒëŠ” ì†”ì§í•˜ê²Œ í•˜ê³  ì‹¶ì€ ê±° í•˜ë©´ì„œ ì§€ë‚´ëŠ” ê²Œ ë‚˜ëŠ” ì¢‹ì€ ê±° ê°™ì•„. ì¹œêµ¬ë“¤ì´ ë‚´ ì„±ê²© ëª¨ë¥´ë©´ ê·¸ê±´ ê·¸ë“¤ ë¬¸ì œì§€. (None) - 4809 sec
-<Chatbot> ë¯¼ìˆ˜ê°€ ë­ë¼ í•˜ë“ ì§€ ë„ˆì˜ ìƒê°ì´ ì¤‘ìš”í•˜ë‹¤ë‹ˆê¹Œ. ì†”ì§í•˜ê²Œ í•˜ê³  ì‹¶ì€ ê±° í•˜ë©´ì„œ ì§€ë‚´ëŠ”ê²Œ ì¢‹ê² ë‹¤ëŠ” ë§ì´, ê·¸ê±¸ ì•„ì£¼ ì˜ ì´í•´í•  ìˆ˜ ìˆì–´! ë‚´ ìƒê°ì—”, ì•ìœ¼ë¡œë„ ë¯¼ìˆ˜ì˜ ìƒê°ì„ ê³„ì† ì†”ì§í•˜ê²Œ í‘œí˜„í•˜ëŠ”ê²Œ ì¢‹ì„ ê²ƒ ê°™ì•„. ê·¸ëŸ°ë°, í™”ë¥¼ ë‚´ì§€ ì•Šê³  ìƒí™©ì„ ì˜ ì²˜ë¦¬í•˜ëŠ” ë²•ì— ëŒ€í•´ ìƒê°í•´ ë³¸ ì ì´ ìˆì–´? ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 9216 sec
-<Child>   ì•„ë‹ˆ, í™”ëŠ” ë‚´ ë§ˆìŒëŒ€ë¡œ ì•ˆ ë‚  ìˆ˜ ìˆëƒê³ . í™”ë‚¬ì„ ë•ŒëŠ” ê·¸ëƒ¥ í™”ë‚´ëŠ” ê±°ì§€. ì™œ ë‚˜í•œí…Œ í™”ë‚´ì§€ ë§ë¼ëŠ” ê±°ì•¼? ê·¸ëŸ¬ë‹ˆê¹Œ ë‹¤ë“¤ ë‚˜í•œí…Œ ë­ë¼ê³  í•˜ì§€ ë§ë¼ë‹ˆê¹Œ. (None) - 4738 sec
-<Chatbot> ì•„, ë¯¸ì•ˆí•´ ë¯¼ìˆ˜ì•¼. ë‚˜ë„ í™”ë‚˜ëŠ” ê°ì •ì„ ì–µì œí•˜ë¼ëŠ” ê²ƒì´ ì•„ë‹ˆì•¼. í™”ê°€ ë‚˜ëŠ” ê±´ ì •ë§ë¡œ í˜ë“  ì¼ì´ì•¼. ê·¸ë¦¬ê³  í™”ê°€ ë‚˜ë„ ë˜ëŠ” ìƒí™©ì´ ìƒê¸¸ ìˆ˜ ìˆê³ , ê·¸ê²Œ ì •ë§ ìì—°ìŠ¤ëŸ¬ìš´ ê±°ì•¼. ê·¸ëŸ°ë°, í™”ê°€ ì–¼ë§ˆë‚˜ ì˜ˆì¸¡í•  ìˆ˜ ì—†ëŠ” ìƒí™©ì„ ë§Œë“œëŠ”ì§€ ì•Œê³  ìˆì–´? ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 7334 sec
-<Child>   ê·¸ë˜, í™”ê°€ ì˜ˆì¸¡ ëª» í•  ìƒí™© ë§Œë“¤ì§€. ê·¸ë˜ì„œ ë‚´ê°€ í™”ë‚¬ì„ ë•ŒëŠ” ê·¸ëƒ¥ ë§í•˜ë‹ˆê¹Œ. í›„íšŒí•˜ëŠ” ê±°ëŠ” ë­í•˜ëŸ¬, ë‚œ ê·¸ëƒ¥ ë‚´ ìŠ¤íƒ€ì¼ëŒ€ë¡œ í•  ê±°ì•¼. (None) - 4022 sec
-<Chatbot> ê·¸ë˜ ì •ë§ ë©‹ì§„ ìƒê°ì´ì•¼, ë¯¼ìˆ˜ì•¼. ì •ë§ë¡œ ê·¸ëŸ´ ìˆ˜ ìˆì–´. ğŸ˜„ í›„íšŒì—†ì´ ë„ˆ ìì‹ ì´ ì›í•˜ëŠ” ëŒ€ë¡œ ì‚¬ëŠ” ê²ƒ, ê·¸ê²Œ ë°”ë¡œ ë©‹ì§„ ì‚¶ì´ë¼ëŠ” ê²ƒì„ ì•Œê³  ìˆì–´. ê·¸ë˜ë„ í˜¹ì‹œ ì•„ì§ í•´ê²°í•˜ì§€ ëª»í•œ ì¼ì´ ìˆì–´? ë„ì™€ì¤„ ìˆ˜ ìˆëŠ” ê±´ ì—†ì„ê¹Œ? ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 7560 sec
-<Child>   ë‚˜í•œí…Œ ë„ì›€ í•„ìš” ì—†ì–´. ì–´ì°¨í”¼ ë‹¤ë“¤ ë‚´ ë§ ì•ˆ ë“¤ì–´. ë‚˜ í˜¼ìì„œ í•´ê²°í•  ê±°ì•¼. ê·¸ëŸ¬ë‹ˆê¹Œ ë” ì´ìƒ ë­ë¼ í•˜ì§€ ë§ê³ . (None) - 4795 sec
-<Chatbot> ì•Œì•˜ì–´ ë¯¼ìˆ˜ì•¼, ë„ˆì˜ ìƒê°ì— ì¡´ì¤‘í• ê²Œ! í˜¼ìì„œ í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ ë§ì€ ë„ì›€ì´ ë  ìˆ˜ ìˆê³ , ê·¸ë¬ìœ¼ë©´ ì¢‹ê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ì–´. ê·¸ë˜ë„ ë˜ ì–¸ì œë“ ì§€ ì–˜ê¸°í•˜ê³  ì‹¶ì„ ë•ŒëŠ” ì–˜ê¸°í•´ë„ ë¼. í˜¹ì‹œ ì§€ê¸ˆ ìŒì•… ë“£ê±°ë‚˜ ê²Œì„ ê°™ì€ ê±° í•¨ê»˜ í•˜ê³  ì‹¶ì–´? ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 8214 sec
-<Child>   ë‚˜ ì§€ê¸ˆ ê²Œì„í•˜ë ¤ê³  í–ˆì–´. ì†”ì§íˆ ë§í•´ì„œ ë„ˆë‘ ë­ í•˜ê³  ì‹¶ì€ ê±´ ì•„ë‹ˆì•¼. ë‚œ ê·¸ëƒ¥ ë‚˜ í˜¼ìì„œ í• ë˜. (None) - 3581 sec
-<Chatbot> ê·¸ë˜, ì•Œì•˜ì–´ ë¯¼ìˆ˜ì•¼. í˜¼ì ìˆëŠ” ê±¸ ì¢‹ì•„í•˜ë‹ˆê¹Œ, í˜¼ìì„œ ì‹œê°„ ë³´ë‚´ëŠ” ê²ƒë„ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•´. í•„ìš”í•˜ë©´ ì–¸ì œë“ ì§€ ë‚˜í•œí…Œ ì—°ë½í•´. FPS ê²Œì„í•˜ëŠ” ë™ì•ˆ ì¦ê±°ìš´ ì‹œê°„ ë³´ë‚´ê¸¸ ë°”ë˜! ğŸ˜„ ê²Œì„ì—ì„œ ì´ê¸°ê³ , ì˜ ì¦ê¸°ê³  ìˆëŠ”ì§€ ê¶ê¸ˆí•˜ë„¤! ê²Œì„ ì˜í•˜ê³  ìˆì§€? ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 8003 sec
-<Child>   ê·¸ëƒ¥ ê²Œì„í•˜ë©´ì„œ ì‹œê°„ ë³´ë‚´. ê±±ì •í•  ê±´ ì—†ì–´. ê²Œì„í•˜ë©´ì„œ ë‚´ ë§˜ëŒ€ë¡œ í•  ê±°ì•¼, ê·¸ëŸ¬ë‹ˆê¹Œ ë„Œ ì‹ ê²½ ì•ˆ ì¨ë„ ë¼. ì™œ ë‚´ê°€ ì–´ë–»ê²Œ ì§€ëƒˆëŠ”ì§€ ê³„ì† ë¬»ì§€? (None) - 4283 sec
-<Chatbot> ì•„ ë¯¼ìˆ˜ì•¼, ë¯¸ì•ˆí•´. ê³„ì† ë¬¼ì–´ë³´ë‹ˆê¹Œ ë¯¼ìˆ˜ê°€ í”¼ê³¤í•˜ê² ë‹¤. ì•„ë¬´íŠ¼, ë¯¼ìˆ˜ê°€ ê²Œì„í•˜ëŠ” ë™ì•ˆ í–‰ë³µí•´ì§€ê¸¸ ë°”ë¼. ê·¸ë¦¬ê³  ë­ë“ ì§€ ë§í•˜ë ¤ê³  í•˜ë©´ ì–¸ì œë“ ì§€ ë‚´ê²Œ ì´ì•¼ê¸°í•˜ë ¤ê³  ìƒê°í•´. ì˜ ë†€ê³  ìˆì§€? ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 7238 sec
-<Child>   ì‘, ë‚˜ ì§€ê¸ˆ ê²Œì„í•˜ë‹ˆê¹Œ. ê·¸ëƒ¥ ë‚´ ë§˜ëŒ€ë¡œ ê²Œì„í•˜ê³  ì‹¶ì–´. ê·¸ëŸ¬ë‹ˆê¹Œ ë„ˆëŠ” ì‹ ê²½ ì•ˆ ì¨ë„ ë¼, ì•Œì•˜ì§€? (None) - 3698 sec
-<Chatbot> ì•Œì•˜ì–´ ë¯¼ìˆ˜ì•¼! í–‰ë³µí•œ ê²Œì„ ì‹œê°„ ë˜ê¸¸ ë°”ë¼. í•„ìš”í•˜ë©´ ì–¸ì œë“ ì§€ ì—°ë½í•´ì¤˜. ê·¸ë˜, FPS ê²Œì„ ì˜ ì¦ê¸°ê³  ìˆê¸¸ ë°”ë˜! ì´ì œëŠ” ë„ˆë¥¼ ë‚´ë²„ë ¤ë‘˜ê²Œ! ğŸ˜„ ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 5175 sec
-<Child>   ê·¸ë˜, ê°„ì„­ ë§ê³  ë‚˜ í˜¼ì ê²Œì„í•˜ê²Œ ë‚´ë²„ë ¤ ë‘¬. ê·¸ëŸ¼ ë‚˜ì¤‘ì— ë´. (None) - 1810 sec
-<Chatbot> ë„¤, ë¯¼ìˆ˜ì•¼! ê²Œì„ ì¬ë¯¸ìˆê²Œ í•˜ê³ , í•„ìš”í•˜ë©´ ì–¸ì œë“  ì—°ë½í•´. ê·¸ëŸ¼, ë‚˜ì¤‘ì— ë´! ğŸ˜„ ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 3682 sec
-<Child>   ì´ì œ ê·¸ë§Œí•˜ìê³ . ê²Œì„í•˜ë ¤ë‹ˆê¹Œ. ê·¸ë˜ë„ ë‚˜ì¤‘ì— ë´. (None) - 2039 sec
-<Chatbot> ë„¤, ì´ì œ ì•ˆ ê±°ìŠ¬ë¦´ê²Œ. ê²Œì„ ì¬ë¯¸ìˆê²Œ í•´! ë‚˜ì¤‘ì— ë´, ë¯¼ìˆ˜ì•¼.ğŸ˜„ ({'state': <EmotionChatbotPhase.Find: 'find'>, 'payload': None}) - 5431 sec
-<Child>   ë‚´ë²„ë ¤ë‘ë©´ì„œ ê³„ì†í•˜ëŠ” ê±´ ë­ëƒê³ . ê·¸ëƒ¥ ë‚˜ í˜¼ì ìˆê²Œ ë‚´ë²„ë ¤ ë‘¬. ì´ì œ ê·¸ë§Œ ì—°ë½í• ë˜. (None) - 3384 sec
Index: .idea/compiler.xml
===================================================================
diff --git a/.idea/compiler.xml b/.idea/compiler.xml
deleted file mode 100644
--- a/.idea/compiler.xml	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ /dev/null	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
@@ -1,6 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<project version="4">
-  <component name="TypeScriptCompiler">
-    <option name="nodeInterpreterTextField" value="$USER_HOME$/.nvm/versions/node/v16.13.0/bin/node" />
-  </component>
-</project>
\ No newline at end of file
Index: .idea/inspectionProfiles/Project_Default.xml
===================================================================
diff --git a/.idea/inspectionProfiles/Project_Default.xml b/.idea/inspectionProfiles/Project_Default.xml
deleted file mode 100644
--- a/.idea/inspectionProfiles/Project_Default.xml	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ /dev/null	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
@@ -1,32 +0,0 @@
-<component name="InspectionProjectProfileManager">
-  <profile version="1.0">
-    <option name="myName" value="Project Default" />
-    <inspection_tool class="Eslint" enabled="true" level="WARNING" enabled_by_default="true" />
-    <inspection_tool class="PyPep8NamingInspection" enabled="true" level="WEAK WARNING" enabled_by_default="true">
-      <option name="ignoredErrors">
-        <list>
-          <option value="N806" />
-          <option value="N802" />
-        </list>
-      </option>
-    </inspection_tool>
-    <inspection_tool class="PyShadowingBuiltinsInspection" enabled="true" level="WEAK WARNING" enabled_by_default="true">
-      <option name="ignoredNames">
-        <list>
-          <option value="input" />
-        </list>
-      </option>
-    </inspection_tool>
-    <inspection_tool class="PyUnresolvedReferencesInspection" enabled="true" level="WARNING" enabled_by_default="true">
-      <option name="ignoredIdentifiers">
-        <list>
-          <option value="dict.trackers" />
-          <option value="tldt.ml.core.entities.ItemSample.__getitem__" />
-        </list>
-      </option>
-    </inspection_tool>
-    <inspection_tool class="RequiredAttributes" enabled="true" level="WARNING" enabled_by_default="true">
-      <option name="myAdditionalRequiredHtmlAttributes" value="onValueChange" />
-    </inspection_tool>
-  </profile>
-</component>
\ No newline at end of file
Index: .idea/modules.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project version=\"4\">\n  <component name=\"ProjectModuleManager\">\n    <modules>\n      <module fileurl=\"file://$PROJECT_DIR$/.idea/llmchat-for-child.iml\" filepath=\"$PROJECT_DIR$/.idea/llmchat-for-child.iml\" />\n    </modules>\n  </component>\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/modules.xml b/.idea/modules.xml
--- a/.idea/modules.xml	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ b/.idea/modules.xml	(date 1690270295408)
@@ -2,7 +2,7 @@
 <project version="4">
   <component name="ProjectModuleManager">
     <modules>
-      <module fileurl="file://$PROJECT_DIR$/.idea/llmchat-for-child.iml" filepath="$PROJECT_DIR$/.idea/llmchat-for-child.iml" />
+      <module fileurl="file://$PROJECT_DIR$/.idea/chatbot-for-kids-emotion.iml" filepath="$PROJECT_DIR$/.idea/chatbot-for-kids-emotion.iml" />
     </modules>
   </component>
 </project>
\ No newline at end of file
Index: auto_chat.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import asyncio\nfrom os import path, getcwd, getenv\n\nimport openai\nfrom chatlib.chatbot.generators import ChatGPTResponseGenerator\nfrom dotenv import load_dotenv\n\nfrom app.response_generator import EmotionChatbotResponseGenerator\nfrom chatlib import cli\n\nif __name__ == \"__main__\":\n    # Init OpenAI API\n    load_dotenv(path.join(getcwd(), \".env\"))\n    openai.api_key = getenv('OPENAI_API_KEY')\n\n    user_name = input(\"Please enter child's name: \").strip()\n    user_age = int(input(\"Please enter child's age: \").strip())\n\n    asyncio.run(cli.run_auto_chat_loop(\n        EmotionChatbotResponseGenerator(user_name=user_name, user_age=user_age, verbose=True),\n        ChatGPTResponseGenerator(base_instruction=f\"\"\"\n                                            You are a {user_age}-year-old Korean child named {user_name} who is shy and worried. \n                                            Your main concern is to mitigate any potential conflicts with your peers. You prefer avoiding any conflicts to asserting your opinions. You always worry about how others think about you. Yesterday, you and your friends went to eat lunch together. Although you can not eat spicy foods, you and your friends end up eating spicy foods since you prioritize others' views over your own. You do not share your concerns with anyone, including your parents.\n\n                                            Speaking rule:\n                                            1. Use a simple, informal Korean like talking to a peer friend. \n                                            2. Say three sentences at the most each time.  \n                                            3. Do not ask question unless you do not understand certain emotion words.  \n                                        \"\"\")\n    ))
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/auto_chat.py b/auto_chat.py
--- a/auto_chat.py	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ b/auto_chat.py	(date 1690263980152)
@@ -2,29 +2,52 @@
 from os import path, getcwd, getenv
 
 import openai
-from chatlib.chatbot.generators import ChatGPTResponseGenerator
 from dotenv import load_dotenv
+from nanoid import generate as generate_id
 
 from app.response_generator import EmotionChatbotResponseGenerator
-from chatlib import cli
+from core.chatbot import DialogueTurn, MultiAgentChatSession
+from core.chatbot.generators import ChatGPTResponseGenerator
+
 
-if __name__ == "__main__":
-    # Init OpenAI API
-    load_dotenv(path.join(getcwd(), ".env"))
-    openai.api_key = getenv('OPENAI_API_KEY')
+def _turn_to_str(turn: DialogueTurn) -> str:
+    return f"{'<Child>  ' if turn.is_user else '<Chatbot>'} {turn.message} ({turn.metadata.__str__() if turn.metadata is not None else None}) - {turn.processing_time} sec"
 
+
+def _on_chat_message(turn: DialogueTurn):
+    print(_turn_to_str(turn))
+
+
+async def run_chat_loop():
+    session_id = generate_id()
+
+    print(f"Start a chat session (id: {session_id}).")
     user_name = input("Please enter child's name: ").strip()
     user_age = int(input("Please enter child's age: ").strip())
-
-    asyncio.run(cli.run_auto_chat_loop(
-        EmotionChatbotResponseGenerator(user_name=user_name, user_age=user_age, verbose=True),
-        ChatGPTResponseGenerator(base_instruction=f"""
-                                            You are a {user_age}-year-old Korean child named {user_name} who is shy and worried. 
-                                            Your main concern is to mitigate any potential conflicts with your peers. You prefer avoiding any conflicts to asserting your opinions. You always worry about how others think about you. Yesterday, you and your friends went to eat lunch together. Although you can not eat spicy foods, you and your friends end up eating spicy foods since you prioritize others' views over your own. You do not share your concerns with anyone, including your parents.
-
-                                            Speaking rule:
-                                            1. Use a simple, informal Korean like talking to a peer friend. 
-                                            2. Say three sentences at the most each time.  
-                                            3. Do not ask question unless you do not understand certain emotion words.  
-                                        """)
-    ))
\ No newline at end of file
+    session = MultiAgentChatSession(session_id,
+                                    EmotionChatbotResponseGenerator(user_name=user_name, user_age=user_age, verbose=True),
+                                    user_generator=ChatGPTResponseGenerator(base_instruction=f"""
+                                        You are a {user_age}-year-old Korean child named {user_name} who is shy and worried. 
+                                        Your main concern is to mitigate any potential conflicts with your peers. You prefer avoiding any conflicts to asserting your opinions. You always worry about how others think about you. Yesterday, you and your friends went to eat lunch together. Although you can not eat spicy foods, you and your friends end up eating spicy foods since you prioritize others' views over your own. You do not share your concerns with anyone, including your parents.
+                                        
+                                        Speaking rule:
+                                        1. Use a simple, informal Korean like talking to a peer friend. 
+                                        2. Say three sentences at the most each time.  
+                                        3. Do not ask question unless you do not understand certain emotion words.  
+                                    """)
+                                    )
+
+    dialogue = await session.generate_conversation(8, _on_chat_message)
+
+    output_path = path.join(getcwd(), f"auto_chat_{session_id}.txt")
+    with open(output_path, "w", encoding='utf-8') as f:
+        f.writelines([f"{_turn_to_str(turn)}\n" for i, turn in enumerate(dialogue)])
+
+    print(f"\nSaved conversation at {output_path}")
+
+if __name__ == "__main__":
+    # Init OpenAI API
+    load_dotenv(path.join(getcwd(), ".env"))
+    openai.api_key = getenv('OPENAI_API_KEY')
+
+    asyncio.run(run_chat_loop())
Index: .idea/vcs.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project version=\"4\">\n  <component name=\"VcsDirectoryMappings\">\n    <mapping directory=\"$PROJECT_DIR$\" vcs=\"Git\" />\n  </component>\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/vcs.xml b/.idea/vcs.xml
--- a/.idea/vcs.xml	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ b/.idea/vcs.xml	(date 1690270295419)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <project version="4">
   <component name="VcsDirectoryMappings">
-    <mapping directory="$PROJECT_DIR$" vcs="Git" />
+    <mapping directory="" vcs="Git" />
   </component>
 </project>
\ No newline at end of file
Index: app/common.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>from enum import StrEnum\n\n\nclass EmotionChatbotPhase(StrEnum):\n    Rapport = \"rapport\"\n    Label = \"label\"\n    Find = \"find\"\n    Record = \"record\"\n    Share = \"share\"\n\n\nCOMMON_SPEAKING_RULES = [\n    \"Use a simple, informal Korean, like talking to a peer friend.\",\n    \"Ask one question per conversation turn.\",\n    \"Say two sentences at the most each time.\",\n    \"Use Emoji appropriately.\",\n    \"Use <em> HTML tags instead of single quotes and to emphasize certain keywords especially those related to emotions.\",\n    \"Avoid using bulleted or numbered list for dialogue.\",\n    \"If the user asks a question that should be asked to adults or unrelated to the conversation topic, then you can say, \\\"I don't know,\\\" and go back to the conversation topic.\"\n]\n\n\ndef stringify_list(rules: list[str], ordered: bool = False, bullet: str = \"-\", separator: str = \"\\n\", indent:str = \"  \") -> str:\n    return separator.join([f\"{indent}{f'{i + 1}.' if ordered else f'{bullet}'} {rule}\" for i, rule in enumerate(rules)])\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/common.py b/app/common.py
--- a/app/common.py	(revision aef5bd6a23c08ce82b24fb53dc281b1ca6ba99b9)
+++ b/app/common.py	(date 1690264000388)
@@ -11,7 +11,8 @@
 
 COMMON_SPEAKING_RULES = [
     "Use a simple, informal Korean, like talking to a peer friend.",
-    "Ask one question per conversation turn.",
+    "Do not use  honorifics",
+    "Ask only one question each time",
     "Say two sentences at the most each time.",
     "Use Emoji appropriately.",
     "Use <em> HTML tags instead of single quotes and to emphasize certain keywords especially those related to emotions.",
